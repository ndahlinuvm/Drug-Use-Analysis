---
title: "Stat235 Final Project"
author: "Nils Dahlin, Connor Guyette, Jon Kramer"
date: "10/20/2022"
output:
  pdf_document: default
  word_document: default
  html_document: default
---
# Stat235 Final Project: Drug Use Analysis
Nils Dahlin, Connor Guyette, and Jon Kramer

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(socviz, tidyverse, rstatix, gridExtra, DescTools, gtExtras, rcompanion, sjPlot)
#tinytex::install_tinytex()

drug_data <- read.csv("Drug_Consumption.csv")
```

## Introduction
Originally this project was going to be a general analysis of drug use and how factors like age, education level, and personality traits can affect a person's chances of using or trying different drugs. Soon into the process however we discovered some discussions about the increase in violent and destructive crime in Burlington and the possibility that it could be linked to an  increase in Meth usage in the city which can lead to more expressive and chaotic outbreaks compared to drugs like Morphine or Heroin which normally have calming or sedative effects for the user. Due to this discovery we thought it would be interesting to focus on Meth as well as Heroin due to the ongoing Opioid epidemic in the region. In this project we will explore the relationships between these drugs and the features of Age and Education as well as looking at further complicated Logistic Regression models at the end with the addition of personality traits to explore those relationships a bit more.

## Data Description
The data set we will be using is a collection of 1884 data points that track different attributes/features of individuals
including age/gender/education level/country/ethnicity/personality trait scores/and drugs used and when. 

Here is a quick look at the first 5 entries of our data set.

```{r quick view}
head(drug_data,5)
```

These are the descriptions for the more nondescript features: 

Personality Traits:<br/>
NScore - Neuroticism<br/>
EScore - Extroversion<br/>
OScore - Openness to Experience<br/>
AScore - Agreeableness<br/>
CScore - Conscientiousness<br/>
Impulsiveness<br/>
SS - Sensation Seeing<br/>
<br/>
The dataset we pulled had altered the personality trait scores for analysis. The scores have been normalized and specific values represent a Z-Score or Standard Deviation. We will be using the scores for Neuroticism, Extroversion, Openness to Experience, Agreeableness, Conscientiousness, and Impulsiveness later on towards the end of this project. 

Drug Use Classifications:
CL0 - Never used<br/>
CL1 - Used over a decade ago<br/>
CL2 - Used in last decade<br/>
CL3 - Used in last year<br/>
CL4 - Used in last month<br/>
CL5 - Used in last week<br/>
CL6 - Used in last day<br/>
<br/>
These classifications will later be reduced to whether an individual has used the drug at some point or never used the drug.

```{r removing features}
# removing features we will not be using
main_df <- select(drug_data, Age, Gender, Education, Country, Nscore, Escore, Oscore, AScore, Cscore, Impulsive, Heroin, Meth)
sjPlot::view_df(main_df,
 show.frq = T,
 show.prc = T,
 show.na = T,
 show.string.values = T)
```

```{r reclassify drug use and education and reorganize}
#Heroin
main_df$Heroin[main_df$Heroin=='CL0'] <- 'Never'
main_df$Heroin[main_df$Heroin=='CL1'] <- 'Over a Decade'
main_df$Heroin[main_df$Heroin=='CL2'] <- 'Last Decade'
main_df$Heroin[main_df$Heroin=='CL3'] <- 'Last Year'
main_df$Heroin[main_df$Heroin=='CL4'] <- 'Last Month'
main_df$Heroin[main_df$Heroin=='CL5'] <- 'Last Week'
main_df$Heroin[main_df$Heroin=='CL6'] <- 'Last Day'

#Methamphetamines
main_df$Meth[main_df$Meth=='CL0'] <- 'Never'
main_df$Meth[main_df$Meth=='CL1'] <- 'Over a Decade'
main_df$Meth[main_df$Meth=='CL2'] <- 'Last Decade'
main_df$Meth[main_df$Meth=='CL3'] <- 'Last Year'
main_df$Meth[main_df$Meth=='CL4'] <- 'Last Month'
main_df$Meth[main_df$Meth=='CL5'] <- 'Last Week'
main_df$Meth[main_df$Meth=='CL6'] <- 'Last Day'

#Education
main_df$Education[main_df$Education=='Left school before 16 years'] <- 'No College/University'
main_df$Education[main_df$Education=='Left school at 16 years'] <- 'No College/University'
main_df$Education[main_df$Education=='Left school at 17 years'] <- 'No College/University'
main_df$Education[main_df$Education=='Left school at 18 years'] <- 'No College/University'
main_df$Education[main_df$Education=='Some college or university, no certificate or degree'] <- 'Some College/University'
main_df$Education[main_df$Education=="Professional certificate/ diploma"] <- "College Degree/Professional Certificate"
main_df$Education[main_df$Education=="University degree"] <- "College Degree/Professional Certificate"
main_df$Education[main_df$Education=="Masters degree"] <- "Masters/Doctorate Degree"
main_df$Education[main_df$Education=="Doctorate degree"] <- "Masters/Doctorate Degree"

#Reordering the features
main_df <- 
  main_df |> 
  mutate(Heroin = factor(Heroin,
                              levels = c("Last Day", "Last Week", "Last Month", "Last Year", "Last Decade", "Over a Decade", "Never")),
        Meth = factor(Meth,
                              levels = c("Last Day", "Last Week", "Last Month", "Last Year", "Last Decade", "Over a Decade", "Never")),
        Education = factor(Education,
                              levels = c("No College/University", "Some College/University", "College Degree/Professional Certificate", "Masters/Doctorate Degree")))


#Squashing Higher Ages
main_df$Age[main_df$Age=="55-64"|main_df$Age=="65+"] <- "55+"

head(main_df)
sjPlot::view_df(main_df,
 show.frq = T,
 show.prc = T,
 show.na = T,
 show.string.values = T)
```


## Data Summary
We are interested in initially looking at the association between age and certain types of drug use as well as personality traits and drug use. From there we are interested at looking at the associations between these controlling for education level. These are some of our initial data summaries:

### Distribution of Ages and Education
```{r}
#plot props
age_prop <- main_df |>
  group_by(Age) |>
  count(Age) |>
  ungroup() |>
  mutate(prop = n/sum(n))

edu_prop <- main_df |>
  group_by(Education) |>
  count(Education) |>
  ungroup() |>
  mutate(prop = n/sum(n))

age_dist <- ggplot(age_prop, aes(x=Age, y=prop))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal()+
  xlab("Age") + ylab("Proportion")

edu_dist <- ggplot(edu_prop, aes(x=Education, y=prop))+
  geom_bar(stat="identity", width=0.7, fill="steelblue")+
  theme_minimal()+
  xlab("Education") + ylab("Proportion")+
  theme(axis.text.x = element_text(angle = 10, vjust=.9))

grid.arrange(age_dist,edu_dist,nrow=1)
  
```
<br/>The distribution of ages is heavily skewed right with the majority of the data consisting of those younger than 45. The amount of data in the youngest bracket is the largest with the amount tailing off as age brackets increase.

### Usage by Age

```{r heavier drug use by age, echo=FALSE}
#Heroin
Age_Heroin_prop<-data.frame(prop.table(xtabs(data = main_df, ~Heroin+Age),margin="Age"))
Age_Heroin_prop

age_h_plt <- ggplot(Age_Heroin_prop, aes(x=Age,y=Freq, fill=Heroin))+
  geom_col()


#Methamphetamines
Age_Meth_prop<-data.frame(prop.table(xtabs(data = main_df, ~Meth+Age),margin="Age"))
Age_Meth_prop

age_m_plt <- ggplot(Age_Meth_prop, aes(x=Age,y=Freq, fill=Meth))+
  geom_col()

grid.arrange(age_h_plt,age_m_plt,nrow=1)
```
<br/>
From an initial analysis of the relationship of Age with Usage there seem to be some interesting patterns. In regards to Heroin it looks there is a pretty even distribution across the age ranges under 55, however there is much more recent use, within the last year, among younger age brackets whereas the use among the higher brackets is largely within the last decade or over a decade ago. In regards to Meth we see a different story with their being a larger proportion of those within younger age brackets using or have used compated to those within the older age brackets.

### Usage by Education
```{r drugs by education}
# Heroin
Edu_Heroin_prop<-data.frame(prop.table(xtabs(data = main_df, ~Heroin+Education),margin="Education"))
Edu_Heroin_prop

edu_h_plt <- ggplot(Edu_Heroin_prop, aes(x=Education,y=Freq, fill=Heroin))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 10, vjust=.9))

# Meth
Edu_Meth_prop<-data.frame(prop.table(xtabs(data = main_df, ~Meth+Education),margin="Education"))
Edu_Meth_prop

edu_m_plt <- ggplot(Edu_Meth_prop, aes(x=Education,y=Freq, fill=Meth))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 10, vjust=.9))

grid.arrange(edu_h_plt,edu_m_plt,nrow=1)

```
<br/>
From an initial analysis on Education and Usage we a bit more variation amongst the groups however there is a noticeable trend with the groups of those having not completed college or some form of higher education having a larger proportion of usage.
<br/>
## Examining Initial Relationships (Tests for Two Variables)
We will now examine the statistical relationships between Usage, Age, and Education starting with simple tests of association between the Age and Education in relation to the usage of these drugs.
<br/>
### Heroin by Age
```{r Heroin by Age}
#reducing heroin usage to whether an individual has used or not
heroin_used_df <- main_df |>
  select(-Meth) |>
  mutate(Heroin=ifelse(Heroin=='Never','Never Used','Has Used'))

#getting counts for each group of heroin by age
heroin_age_freq <-
  xtabs(formula = ~ Age + Heroin,
        data = heroin_used_df) 

#visualization of marginal proportions
ggplot(data.frame(prop.table(heroin_age_freq, margin = "Age")), aes(x=Age,y=Freq, fill=Heroin))+
  geom_col(position = "dodge")

#creating df of marginal props for Chi-squared test
heroin_age_freq |> 
  # Convert counts to conditional proportions
  prop.table(margin = "Age") |> 
  # Display 3 significant digits
  signif(digits = 3) |> 
  # Convert to a data frame
  data.frame() |> 
  pivot_wider(names_from = "Heroin",
              values_from = "Freq")

#testing association
chisq_test(x=heroin_age_freq)
cramerV(heroin_age_freq,
        ci = T,
        conf = 0.95)
```
We can see from the initial graph there is not that much difference between the groups when we reduce the used or not. This is isn't unexpected from our initial exploration. Further the results of the Chi-square test returned a p-value of 0.78 which would lead us to failing to reject the null hypothesis of the test and conclude that there is not a significant association between Heroin usage and Age.

### Heroin by Education
```{r Heroin by Education}
#getting counts for each group of heroin by education
heroin_edu_freq <-
  xtabs(formula = ~ Education + Heroin,
        data = heroin_used_df) 

#visualization of marginal proportions
ggplot(data.frame(prop.table(heroin_edu_freq, margin = "Education")), aes(x=Education,y=Freq, fill=Heroin))+
  geom_col(position = "dodge")

#creating df of marginal props for Chi-squared test
heroin_edu_freq |> 
  # Convert counts to conditional proportions
  prop.table(margin = "Education") |> 
  # Display 3 significant digits
  signif(digits = 3) |> 
  # Convert to a data frame
  data.frame() |> 
  pivot_wider(names_from = "Heroin",
              values_from = "Freq")

#testing association
chisq_test(x=heroin_edu_freq)
cramerV(heroin_edu_freq,
        ci = T,
        conf = 0.95)
```
The initial graph for Education and Heroin however shows a bit more variation among the groups. When we run the Chi-square test we can see that the resulting p-value is very small which would lead us to rejecting the null hypothesis and concluding that there is a significant association between Education and Heroin usage.


### Meth by Age
```{r Meth by Age}
meth_used_df <- main_df |>
  select(-Heroin) |>
  mutate(Meth=ifelse(Meth=='Never','Never Used','Has Used'))

#meth_used_df$Meth = ifelse(meth_used_df$Meth=='Never','Never Used','Has Used')

# ggplot(data = meth_used_df,
#        mapping = aes(Meth, ..count..)) +
#   geom_bar(aes(fill = Age),
#            position = "dodge")

meth_age_freq <-
  xtabs(formula = ~ Age + Meth,
        data = meth_used_df) 

ggplot(data.frame(prop.table(meth_age_freq, margin = "Age")), aes(x=Age,y=Freq, fill=Meth))+
  geom_col(position = "dodge")

meth_age_freq |> 
  # Convert counts to conditional proportions
  prop.table(margin = "Age") |> 
  # Display 3 significant digits
  signif(digits = 3) |> 
  # Convert to a data frame
  data.frame() |> 
  # Changing drive_end from 1 column to a column per way the drive ends
  pivot_wider(names_from = "Meth",
              values_from = "Freq")

chisq_test(x=meth_age_freq)
cramerV(meth_age_freq,
        ci = T,
        conf = 0.95)
```

### Meth by Education
```{r Meth by Education}
# ggplot(data = meth_used_df,
#        mapping = aes(Meth, ..count..)) +
#   geom_bar(aes(fill = Education),
#            position = "dodge")

meth_edu_freq <-
  xtabs(formula = ~ Education + Meth,
        data = meth_used_df)

ggplot(data.frame(prop.table(meth_edu_freq, margin = "Education")), aes(x=Education,y=Freq, fill=Meth))+
  geom_col(position = "dodge")

meth_edu_freq |> 
  # Convert counts to conditional proportions
  prop.table(margin = "Education") |> 
  # Display 3 significant digits
  signif(digits = 3) |> 
  # Convert to a data frame
  data.frame() |> 
  # Changing drive_end from 1 column to a column per way the drive ends
  pivot_wider(names_from = "Meth",
              values_from = "Freq")

chisq_test(x=meth_edu_freq)
cramerV(meth_edu_freq,
        ci = T,
        conf = 0.95)
```
Looking at the results for Meth we can see from the initial visualization that there definitely seems to be some noticeable variation between the groups when looking at both Age and Education. In both instances the p-values were small enough to lead us to rejecting the null hypothesis and concluding that there are significant associations between both of these variables and Meth usage.

## Examining More Complicated Relationships (Tests for Multiple Variables)
After doing our initial analysis we will now dive a little deeper into the usage of these drugs and examine the more complicated relationships between the combination of Age and Education in relation to Usage instead of looking at them separately.

### Heroin
#### Complete Independence
```{r Heroin Complete Independence}
#Getting Counts and Expected Proportions
heroin_sum <- 
  heroin_used_df |> 
  count(Age, Education, Heroin) |> 
  # Calculating the proportions: n/sum(n)
  mutate(FA_prop = n/sum(n))
heroin_sum

I <- n_distinct(heroin_used_df$Education)
J <- n_distinct(heroin_used_df$Heroin)
K <- n_distinct(heroin_used_df$Age)

heroin_CI <- 
  heroin_sum |> 
  group_by(Age) |> 
  mutate(age_n = sum(n)) |> 
  ungroup() |> 
  
  group_by(Education) |> 
  mutate(edu_n = sum(n)) |> 
  ungroup() |> 
  
  group_by(Heroin) |> 
  mutate(heroin_n = sum(n)) |> 
  ungroup() |> 
  
  # Now we can calculate the expected proportion for each outcome assuming complete independence
  mutate(CI_prop = age_n/sum(n) * edu_n/sum(n) * heroin_n/sum(n)) |> 
  
  # Dropping the count columns because we don't need them in the future:
  select(-age_n, -edu_n, -heroin_n)

heroin_CI

#Getting Test Statistics:
CI_FA_test <- 
  heroin_CI |> 
  # Calculating the individual pieces of our test statistics (chi^2 and G)
  mutate(zi2 = (FA_prop - CI_prop)^2/CI_prop,
         gi = n*log(FA_prop/CI_prop)) |> 
  
  # Adding the individual pieces to get the test statistic:
  summarize(chi2 = sum(n)*sum(zi2),
            lrt_g = 2*sum(gi)) |> 
  
  # Changing the results from being stored in separate columns to the same column
  pivot_longer(cols = chi2:lrt_g,
               names_to = "test",
               values_to = "stat")

CI_FA_test

# Calculating P-Values:
# The number of unique proportions needed for the FA model
r1 <- I*J*K - 1

# The number of unique proportions needed for the CI model
r0 <- I + J + K - 3

# The degrees of freedom: r1 - r0
df_CI <- r1 - r0
df_CI

CI_FA_test |> 
  mutate(p_val = pchisq(stat, df = df_CI, lower = F))

#Checking Sample Size:
heroin_CI |> 
  mutate(n_CI = sum(n)*CI_prop) |> 
  arrange(n_CI)

#Finding Where Differences Occur:
heroin_CI |>
  
  # Calculating the Standardized z-score for each of the 16 groups:
  mutate(zi = (FA_prop - CI_prop)/sqrt(CI_prop * (1-CI_prop)/sum(n))) |> 
  
  # Creating the heat map using ggplot and geom_tile()
  ggplot(mapping = aes(x = Heroin,
                       y = Education,
                       fill = zi)) + 
  
  geom_tile(color = "white") + 
  
  geom_text(mapping = aes(label = round(zi, digits = 2))) +
  
  facet_wrap(facets = ~ Age) + 
  
  # Removes the buffer around the plot
  coord_cartesian(expand = F) + 
  
  scale_fill_gradient2(low = "red",
                       mid = "white",
                       high = "green",
                       midpoint = 0) + 
  
  labs(x = "Used Heroin or Not",
       y = "Education",
       fill = "z-score for \nFA vs CI models")
```

#### Joint Independence
```{r Heroin Joint Independence}
heroin_JI <- 
  heroin_used_df |> 
  mutate(edu_use = interaction(Education, Heroin, sep = ":"))

heroin_JI |> 
  head(n = 10)

JI_vs_FA <- 
  chisq_test(x = heroin_JI$edu_use,
             y = heroin_JI$Age)

JI_vs_FA

#Checking Expected Counts:
expected_freq(JI_vs_FA) |> 
  round(digits = 1)

#Finding Where Differences Occur:
std_residuals(JI_vs_FA) |> 
  data.frame() |> 
  
  rename(std_res = Freq,
         Age = y) |> 
  
  # Separate will split apart the two variables that we combined together
  separate(col = x,                               # Column to split
           into = c("Education", "Heroin"),  # name of the new columns
           sep = ":") |>                          # Where to split the column
  
  # Creating the heat map using ggplot and geom_tile()
  ggplot(mapping = aes(x = Heroin,
                       y = Education,
                       fill = std_res)) + 
  
  geom_tile(color = "white") + 
  
  geom_text(mapping = aes(label = round(std_res, digits = 2))) +
  
  facet_wrap(facets = ~ Age) + 
  
  # Removes the buffer around the plot
  coord_cartesian(expand = F) + 
  
  scale_fill_gradient2(low = "red",
                       mid = "white",
                       high = "green",
                       midpoint = 0) + 
  
  labs(x = "Used Heroin or Not",
       y = "Education",
       fill = "z-score for \nFA vs JI models")
```

#### Conditional Independence
```{r Cond Ind test Heroin }

# drug_data <- mutate(drug_data, has_used_Heroin = ifelse(Heroin == "CL0", "Never", "Used"))
# 
# drug_data_comb_old <- mutate(drug_data, Age = ifelse(Age == "65+","55-64",Age))
# 
# drug_data_test <- mutate(drug_data_comb_old, college= ifelse(Education %in% c("Left school at 18 years","Left school at 17 years","Left school at 16 years","Left school before 16 years"), "No College", Education))|>
#   mutate(college= ifelse(Education == "Some college or university, no certificate or degree","Some College",college))|>
#   mutate(college= ifelse(Education %in% c("Doctorate degree","Masters degree","Professional certificate/ diploma","University degree"), "Graduated", college))


I <- n_distinct(heroin_used_df$Education)
J <- n_distinct(heroin_used_df$Heroin)
K <- n_distinct(heroin_used_df$Age)


partial_chisq_tests_Her <- 
  heroin_used_df |>
  # Group by the control variable, Z
  
  group_by(Education) |> 
  
  # Calculating the test statistic, df, and p-value for each individual partial table
  summarize(test_stat = chisq_test(Heroin, Age)$statistic,
            df = chisq_test(Heroin, Age)$df,
            p_val = chisq_test(Heroin, Age)$p)


cond_ind_test_Her <- partial_chisq_tests_Her$test_stat |> sum()

cond_ind_test_Her




df<- (I*J*K) - 1 -((I + J -1)*K) - 1


# P-value:
pchisq(q = cond_ind_test_Her,
       df = df,
       lower = F)
       
#With a p-value >.05, we fail to reject the null hypothesis and conclude in favor of the null hypothesis. We do not have strong evidence that the odds ratios for heroin use by age at different levels of education are unequal, and none are equal to one.
```
With a test statistic of 12.495 and 8 degrees of freedom the resulting P-value is .130. With a P-value > .05 we fail to reject our null hypothesis that the relationship between Age and Heroin use is conditional on Education level, and conclude that the relationship between Age and Heroin use could be conditionally dependent on Education level.



##### Expected values check
```{r}
heroin_used_df |> 
  group_by(Age) |> 
  
  summarize(below_5 = sum(chisq.test(Heroin, Education)$expected <5))

```

There is one expected count below 5, but all the other counts pass the check

#### Homogenous Test
```{r Homogenous Test}
#make education variable binary so we can run homogenous test
heroin_used_df <- mutate(heroin_used_df, college= ifelse(Education %in% c("Masters/Doctorate Degree","College Degree/Professional Certificate"), "Graduated", "Didn't Graduate"))
       
#run Chi square test to first test for association between age and education

chisq_test(x = heroin_used_df$Age,
           y = heroin_used_df$college)


#run Breslow Day test for association between heroin use and age at different levels of education
drug_data_BDtest <- 
  xtabs(formula = ~ Heroin + college + Age,
        data = heroin_used_df) |> 
  
  BreslowDayTest()

drug_data_BDtest


```
We fail to reject the null and conclude we do not have strong evidence in favor of the alternative. We do not have strong evidence that the odds ratios for heroin use by age at different levels of education are unequal.

### Meth
Here we are comparing Meth and Age and Edu

#### Complete Independence
```{r Meth Complete Independence}
#Getting Counts and Expected Values:
meth_sum <- 
  meth_used_df |> 
  count(Age, Education, Meth) |> 
  # Calculating the proportions: n/sum(n)
  mutate(FA_prop = n/sum(n))
meth_sum

I <- n_distinct(meth_used_df$Education)
J <- n_distinct(meth_used_df$Meth)
K <- n_distinct(meth_used_df$Age)

meth_CI <- 
  meth_sum |> 
  group_by(Age) |> 
  mutate(age_n = sum(n)) |> 
  ungroup() |> 
  
  group_by(Education) |> 
  mutate(edu_n = sum(n)) |> 
  ungroup() |> 
  
  group_by(Meth) |> 
  mutate(meth_n = sum(n)) |> 
  ungroup() |> 
  
  # Now we can calculate the expected proportion for each outcome assuming complete independence
  mutate(CI_prop = age_n/sum(n) * edu_n/sum(n) * meth_n/sum(n)) |> 
  
  # Dropping the count columns because we don't need them in the future:
  select(-age_n, -edu_n, -meth_n)

meth_CI

#Getting Test Statistics:
CI_FA_test <- 
  meth_CI |> 
  # Calculating the individual pieces of our test statistics (chi^2 and G)
  mutate(zi2 = (FA_prop - CI_prop)^2/CI_prop,
         gi = n*log(FA_prop/CI_prop)) |> 
  
  # Adding the individual pieces to get the test statistic:
  summarize(chi2 = sum(n)*sum(zi2),
            lrt_g = 2*sum(gi)) |> 
  
  # Changing the results from being stored in separate columns to the same column
  pivot_longer(cols = chi2:lrt_g,
               names_to = "test",
               values_to = "stat")

CI_FA_test

# Calculating P-Values:
# The number of unique proportions needed for the FA model
r1 <- I*J*K - 1

# The number of unique proportions needed for the CI model
r0 <- I + J + K - 3

# The degrees of freedom: r1 - r0
df_CI <- r1 - r0
df_CI

CI_FA_test |> 
  mutate(p_val = pchisq(stat, df = df_CI, lower = F))

#Checking Sample Size:
meth_CI |> 
  mutate(n_CI = sum(n)*CI_prop) |> 
  arrange(n_CI)

#Finding Where Differences Occur:
meth_CI |>
  
  # Calculating the Standardized z-score for each of the 16 groups:
  mutate(zi = (FA_prop - CI_prop)/sqrt(CI_prop * (1-CI_prop)/sum(n))) |> 
  
  # Creating the heat map using ggplot and geom_tile()
  ggplot(mapping = aes(x = Meth,
                       y = Education,
                       fill = zi)) + 
  
  geom_tile(color = "white") + 
  
  geom_text(mapping = aes(label = round(zi, digits = 2))) +
  
  facet_wrap(facets = ~ Age) + 
  
  # Removes the buffer around the plot
  coord_cartesian(expand = F) + 
  
  scale_fill_gradient2(low = "red",
                       mid = "white",
                       high = "green",
                       midpoint = 0) + 
  
  labs(x = "Used Meth or Not",
       y = "Education",
       fill = "z-score for \nFA vs CI models")
  #We calculated a p-value less than .05, so we reject the null and conclude in favor of the alternative hypothesis. We have strong evidence that at leat 2 of our three variables (age, education, meth use) are associated
```
Based on

#### Joint Independence
```{r Joint Independence}
meth_JI <- 
  meth_used_df |> 
  mutate(edu_use = interaction(Education, Meth, sep = ":"))

meth_JI |> 
  head(n = 10)

JI_vs_FA <- 
  chisq_test(x = meth_JI$edu_use,
             y = meth_JI$Age)

JI_vs_FA

#Checking Expected Counts:
expected_freq(JI_vs_FA) |> 
  round(digits = 1)

#Finding Where Differences Occur:
std_residuals(JI_vs_FA) |> 
  data.frame() |> 
  
  rename(std_res = Freq,
         Age = y) |> 
  
  # Separate will split apart the two variables that we combined together
  separate(col = x,                               # Column to split
           into = c("Education", "Meth"),  # name of the new columns
           sep = ":") |>                          # Where to split the column
  
  # Creating the heat map using ggplot and geom_tile()
  ggplot(mapping = aes(x = Meth,
                       y = Education,
                       fill = std_res)) + 
  
  geom_tile(color = "white") + 
  
  geom_text(mapping = aes(label = round(std_res, digits = 2))) +
  
  facet_wrap(facets = ~ Age) + 
  
  # Removes the buffer around the plot
  coord_cartesian(expand = F) + 
  
  scale_fill_gradient2(low = "red",
                       mid = "white",
                       high = "green",
                       midpoint = 0) + 
  
  labs(x = "Used Meth or Not",
       y = "Education",
       fill = "z-score for \nFA vs JI models")
  #With a p-value less than .05, we reject the null and conclude that we have strong evidence in favor of the alternative. We have strong evidence that at least age or education is assoicated with meth use.
```

####Conditional Independence
```{r conditional Ind Meth, warning=FALSE}
# drug_data_comb_old <- mutate(drug_data_comb_old, has_used_Meth = ifelse(Meth == "CL0", "Never", "Used"))
# 
# 
# 
# drug_data_test <- mutate(drug_data_comb_old, college= ifelse(Education %in% c("Left school at 18 years","Left school at 17 years","Left school at 16 years","Left school before 16 years"), "No College", Education))|>
#   mutate(college= ifelse(Education == "Some college or university, no certificate or degree","Some College",college))|>
#   mutate(college= ifelse(Education %in% c("Doctorate degree","Masters degree","Professional certificate/ diploma","University degree"), "Graduated", college))



I <- n_distinct(meth_used_df$Education)
J <- n_distinct(meth_used_df$Meth)
K <- n_distinct(meth_used_df$Age)
  

partial_chisq_tests_Meth <- 
  meth_used_df |>
  # Group by the control variable, Z
  
  group_by(Education) |> 
  
  # Calculating the test statistic, df, and p-value for each individual partial table
  summarize(test_stat = chisq_test(Meth, Age)$statistic,
            df = chisq_test(Meth, Age)$df,
            p_val = chisq_test(Meth, Age)$p)


cond_ind_test_Meth <- partial_chisq_tests_Meth$test_stat |> sum()
cond_ind_test_Meth

df<-(I*J*K) - 1 -((I + J -1)*K) - 1

# P-value:
pchisq(q = cond_ind_test_Meth,
       df = df,
       lower = F)
#With a p-value <.05, we reject the null hypothesis and conclude in favor of the alternative hypothesis. We have strong evidence that the odds ratios for meth use by age at different levels of education are unequal, and none are equal to one.
```
With a test statistic of 42.379 and 8 degrees of freedom the resulting P-value is ~0. With a P-value < .05 we reject our null hypothesis that the relationship between age and Heroin use is conditional on education level.


##### Expected value check
```{r warning=TRUE}


meth_used_df |> 
  group_by(Age) |> 
  
  summarize(below_5 = sum(chisq.test(Meth, Education)$expected <5))
```

There is one expected count below 5, but all the other counts pass the check

#### Homogenous Test
```{r Homogenous test}
#make education variable binary so we can run homogenous test
meth_used_df <- mutate(meth_used_df, college= ifelse(Education %in% c("Masters/Doctorate Degree","College Degree/Professional Certificate"), "Graduated", "Didn't Graduate"))
       
#run Chi square test to first test for association between age and education

chisq_test(x = meth_used_df$Age,
           y = meth_used_df$college)

#run Breslow Day test for association between drug use and age at different levels of education
drug_data_BDtest <- 
  xtabs(formula = ~ Meth + college + Age,
        data = meth_used_df) |> 
  
  BreslowDayTest()

drug_data_BDtest


# After running the Breslow Day Test, we computed a chi-squared value of 3.347, and a p-value of .5015. We fail to reject the null and conclude we do not have strong evidence in favor of the alternative. We do not have strong evidence that the odds ratios for meth use by age at different levels of education are unequal.

```


### Logistic Regression - Looking at Meth Use
```{r reclassify meth use}
# 0 = Never used, 1 = Has used
meth_log_reg <- meth_used_df |>
  mutate(use = ifelse(Meth=="Never Used",0,1)) |>
  select(-Meth)
```

#### Looking at How Age and Education Affect Meth Use
```{r}
add_model <- 
  glm(formula = use ~ Age + Education,
      #weight = ?,
      family = binomial,
      data = meth_log_reg)

int_model <- 
  glm(formula = use ~ Age * Education,
      #weight = ?,
      family = binomial,
      data = meth_log_reg)

fit_stats <- 
  bind_rows(
    "add" = glance(add_model),
    "int" = glance(int_model),
    .id = "model"
    )

fit_stats

c("test stat" = fit_stats$deviance |> diff() |> abs(),
  "p-value" = pchisq(q = fit_stats$deviance |> diff() |> abs(),
                     df = fit_stats$df.residual |> diff() |> abs(),
                     lower = F))

age_model <- 
  glm(formula = use ~ Age,
      #weight = ?,
      family = binomial,
      data = meth_log_reg)

# Now we can use anova just by giving it multiple models from simplest to the most complicated:
anova(age_model, add_model, int_model, 
      test = "LRT")
```


#### Stepwise Model Selection
```{r stepwise model selection}
min_model <- 
  glm(formula = use ~ 1,  # 1 means intercept only
      family = binomial,
      data = meth_log_reg)
max_model <- 
  glm(formula = use ~ .,
      family = binomial,
      data = meth_log_reg)

#Forward Selection of features
forward_glm <- 
  MASS::stepAIC(object = min_model,
                direction = "forward",
                scope = formula(max_model),
                trace = 0)

#Backward Selection of features
backward_glm <- 
  MASS::stepAIC(object = min_model,
                direction = "forward",
                scope = formula(max_model),
                trace = 0)

#Results from forward, backward, and both selection
both_glm <- 
  MASS::stepAIC(object = min_model,
                direction = "both",
                scope = formula(max_model),
                trace = 0)

c("forward"  = forward_glm$formula,
  "backward" = backward_glm$formula,
  "both"     = both_glm$formula)
```

```{r}
#suggested model
sugg_model <- glm(formula = use ~ Country + Cscore + Education + Oscore + AScore + Nscore + 
    Impulsive + Escore,
      family = binomial,
      data = meth_log_reg)

summary(sugg_model)
anova(sugg_model)

predictions <- predict(sugg_model,
        newdata = meth_log_reg, 
        type = "response") |> 
  
  round(digits = 3) #|> 
  
  #data.frame()

pred_df <- meth_log_reg |>
  mutate(pred_used = ifelse(predictions>.5,1,0),
         correct_pred = ifelse(use==pred_used,1,0))
head(pred_df,15)

#overall accuracy
model_acc <- sum(pred_df$correct_pred)/length(pred_df$correct_pred)
model_acc

#accuracy predicting use
aggregate(correct_pred~use,data=pred_df,FUN = sum)
correct_use_pred = 195
total_num_use = sum(pred_df$use==1)
correct_pred_acc = correct_use_pred/total_num_use
correct_pred_acc

```



#### Multinomial Regression
```{r}
#using full recommended
# meth_use_nnet <- multinom(use ~ Country + Impulsive + Age + Nscore + Education + Oscore + 
#     AScore + Cscore, 
#                           data = meth_log_reg)
meth_use_nnet <- multinom(use ~ Impulsive + Nscore + Oscore + AScore + Cscore, 
                          data = meth_log_reg)

tidy(meth_use_nnet)
glance(meth_use_nnet)

predict(meth_use_nnet,
        newdata = meth_used_df, 
        type = "probs") |> 
  
  round(digits = 3) |> 
  
  data.frame()
```
